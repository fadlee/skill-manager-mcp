# AGENTS.md - Hono Backend (Workers)

> Cloudflare Workers backend for Skill Manager API and MCP server

## Package Identity

- **Purpose:** REST API and MCP server for skill management
- **Framework:** Hono on Cloudflare Workers
- **Database:** Cloudflare D1 (SQLite)
- **Protocol:** MCP (Streamable HTTP Transport)

## Setup & Run

```bash
# From project root
bun install
bun run dev           # Dev server (includes worker)
bun run deploy        # Deploy to Cloudflare
bun run cf-typegen    # Generate Cloudflare types
```

## Patterns & Conventions

### File Organization (Planned)

```
src/worker/
├── index.ts              # Main entry, route registration
├── routes/
│   ├── api.ts            # REST API routes (/api/*)
│   └── mcp.ts            # MCP handler (/mcp)
├── services/
│   └── skill.service.ts  # Business logic
├── repositories/
│   └── skill.repo.ts     # Database operations
├── types/
│   └── index.ts          # Worker-specific types
└── lib/
    ├── mcp.ts            # MCP protocol helpers
    └── utils.ts          # Utilities
```

### Route Patterns

- ✅ **DO:** Group routes by domain (`/api/skills/*`, `/mcp`)
- ✅ **DO:** Use Hono's typed context: `Hono<{ Bindings: Env }>`
- ✅ **DO:** Return JSON responses: `c.json({ ok: true, data: ... })`
- ❌ **DON'T:** Access D1 directly in routes (use repositories)

### Current Example

```typescript
// src/worker/index.ts
import { Hono } from "hono";
const app = new Hono<{ Bindings: Env }>();

app.get("/api/", (c) => c.json({ name: "Cloudflare" }));

export default app;
```

### Error Handling (Planned)

```typescript
// Use AppError class for consistent errors
throw new AppError('NOT_FOUND', 'Skill not found', 404);
throw new AppError('VALIDATION_ERROR', 'Invalid input', 400);
```

### Authentication (Planned)

- MCP endpoints: `Authorization: Bearer <MCP_API_KEY>`
- API key stored as Cloudflare secret: `wrangler secret put MCP_API_KEY`

## Touch Points / Key Files

| File | Purpose |
|------|---------|
| `index.ts` | Main entry, Hono app setup |
| `routes/api.ts` | REST API routes (planned) |
| `routes/mcp.ts` | MCP protocol handler (planned) |
| `services/skill.service.ts` | Skill business logic (planned) |
| `repositories/skill.repo.ts` | D1 database operations (planned) |

## JIT Index Hints

```bash
# Find API routes
rg -n "app\.(get|post|put|patch|delete)" src/worker/

# Find Hono middleware
rg -n "app\.use" src/worker/

# Find service methods
rg -n "async.*\(" src/worker/services/

# Find repository methods
rg -n "async.*\(" src/worker/repositories/

# Find TypeScript interfaces
rg -n "^export (interface|type)" src/worker/
```

## Database (D1)

### Schema Location
- Migrations: `migrations/` (planned)
- Schema reference: `docs/tdd.md` section 4

### Key Tables
- `skills` - Skill metadata
- `skill_versions` - Version history
- `skill_files` - File contents per version

### Commands (Planned)
```bash
# Run migrations
wrangler d1 migrations apply skill-manager-db

# Query local D1
wrangler d1 execute skill-manager-db --local --command "SELECT * FROM skills"
```

## MCP Tools (Planned)

| Tool | Description |
|------|-------------|
| `skill.create` | Create new skill with files |
| `skill.update` | Update skill (creates new version) |
| `skill.list` | List all skills |
| `skill.get` | Get skill details |
| `skill.get_file` | Get file content |

## Common Gotchas

- `Env` type is auto-generated by `bun run cf-typegen`
- D1 binding must be configured in `wrangler.json`
- Worker entry is `src/worker/index.ts` (see `wrangler.json`)
- Static assets served from `dist/client` after build

## Pre-PR Checks

```bash
bun run check  # TypeScript + build + dry-run deploy
```
